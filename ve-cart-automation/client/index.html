<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VE Cart Automation</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: #fff;
    padding: 20px;
  }
  h1, h2 { color: #0f0; }
  .product {
    background: #222;
    padding: 10px;
    margin: 10px 0;
    border-radius: 6px;
  }
  button {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 5px;
    background-color: #007bff;
    color: white;
  }
  button:hover {
    background-color: #0056b3;
  }
  #cart {
    margin-top: 20px;
    padding: 10px;
    background: #333;
    border-radius: 6px;
  }
  #log {
    margin-top: 20px;
    padding: 10px;
    background: black;
    height: 200px;
    overflow-y: auto;
    font-family: monospace;
    border-radius: 6px;
  }
</style>
</head>
<body>

<h1>VE Cart Automation</h1>
<p>Add items to your cart, then send them to the server to open automatically in new tabs.</p>

<div id="products"></div>

<h2>Your Cart</h2>
<div id="cart">(empty)</div>

<button id="checkoutBtn" style="background:#0f0;color:black;font-weight:bold;">Checkout</button>

<h2>Log</h2>
<div id="log"></div>

<script>
const products = [
  { name: "Divider", url: "https://portal.veinternational.org/buybuttons/us019814/btn/divider-odi/" },
  { name: "Ice Molds", url: "https://portal.veinternational.org/buybuttons/us019814/btn/ice-molds-oim/" },
  { name: "Shaker Ball", url: "https://portal.veinternational.org/buybuttons/us019814/btn/shaker-ball-osb/" },
  { name: "The Anchor (Snack Compartment)", url: "https://portal.veinternational.org/buybuttons/us019814/btn/the-anchor-snack-compartment-oan/" },
  { name: "Surge IV (Blue Razzberry)", url: "https://portal.veinternational.org/buybuttons/us019814/btn/surge-iv-blue-razzberry-suel1/" },
  { name: "Fall Bundle", url: "https://portal.veinternational.org/buybuttons/us019814/btn/fall-bundle-sef3/" },
  { name: "Peak Protein (Pumpkin Spice)", url: "https://portal.veinternational.org/buybuttons/us019814/btn/peak-protein-pumpkin-spice-supr3/" }
];

let cart = [];
let sessionId = null;

// WebSocket connection
const ws = new WebSocket("ws://192.168.1.94:8081");

ws.onopen = () => log("WebSocket connected");
ws.onmessage = (event) => {
  const msg = JSON.parse(event.data);
  if (msg.type === "sessionId") {
    sessionId = msg.sessionId;
    log("Session ID received: " + sessionId);
  } else if (msg.type === "cartLinks") {
    log("Opening cart links...");
    msg.links.forEach(link => window.open(link, "_blank"));
  }
};

function log(message) {
  const logDiv = document.getElementById("log");
  logDiv.innerHTML += message + "<br>";
  logDiv.scrollTop = logDiv.scrollHeight;
}

function addToCart(product) {
  cart.push(product);
  updateCart();
  log("Added to cart → " + product.name);
}

function updateCart() {
  const cartDiv = document.getElementById("cart");
  if (!cart.length) {
    cartDiv.innerHTML = "(empty)";
    return;
  }
  cartDiv.innerHTML = cart.map(p => p.name).join("<br>");
}

function checkout() {
  if (!cart.length) {
    log("⚠ Cart empty");
    return;
  }
  if (!sessionId) {
    log("⚠ Waiting for WebSocket session...");
    return;
  }

  const links = cart.map(p => p.url);
  fetch("http://192.168.1.94:8080/sendCart", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ sessionId, links })
  })
  .then(res => res.json())
  .then(data => log("✔ Checkout triggered — links sent to server"))
  .catch(err => log("❌ Error sending checkout: " + err));
}

// Render products
const productsDiv = document.getElementById("products");
products.forEach(p => {
  const div = document.createElement("div");
  div.className = "product";
  div.innerHTML = `<strong>${p.name}</strong><br><button>Add to Cart</button>`;
  div.querySelector("button").addEventListener("click", () => addToCart(p));
  productsDiv.appendChild(div);
});

// Checkout button
document.getElementById("checkoutBtn").addEventListener("click", checkout);
</script>

</body>
</html>
